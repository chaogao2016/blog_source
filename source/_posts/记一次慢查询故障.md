---
title: 记一次慢查询故障
date: 2020-05-11 21:00:15
tags: [debug]
---
### 现象：
&emsp;&emsp;访问本地后台开发主页过于缓慢。
检查后发现，是主页通过iframe加载的三个子布局top,left,right太卡，以单个left布局的请求时间来看，总时间长达45秒左右。
<!--more-->
&emsp;&emsp;对比远端测试环境的相同请求并没有这么长的耗时，由于远端和本地的代码一致，且两者都是访问的远端的测试环境数据库服务，所以猜测是由于本地环境配置不对造成的慢请求。

&emsp;&emsp;开始调试。

- 第一步在该慢请求的控制器入口处打断点。
  + 结果很快就在此处中断了。说明卡顿的原因还在后面。
 
&emsp;&emsp;在这个控制器中代码很少，一共三行：
```php
$left_tree = $this->adminModel->get_nav_tree(0, 1, '', $this->AdminLanguageId);
$data = array('left_tree'=>$left_tree);
$this->load->view('left',$data);
```
&emsp;&emsp;其实就是从数据库查出数据，拼装，载入视图，接下来逐个打断点试试。

- 在第一行之后打断点。
  + 这回就卡住了，基本卡了40秒，可以确定是数据库慢查询导致的慢请求，但是这不能解释测试环境为什么没这问题。
 
 &emsp;&emsp;接下来进入到get_nav_tree方法，深究查询逻辑，寻找导致慢查询的原因。
 
 &emsp;&emsp;奇怪的事情发生了，常理说我定位到任意一个sql就可以查到问题原因了，但是在这里出现了问题，我无论把断点打在哪个位置，请求一直在超时，最后我把断点打在了入口处，发现依然超时。这下问题大条了，这说明这很有可能是一个复合bug，多个bug叠加在一起造成了这个现象。
 
 &emsp;&emsp;我继续在入口断点，测试10次，如果依然如此，那我就要去查看apache服务器的配置。
 
 &emsp;&emsp;断点查询了一会，有了一些思路。我发现一个现象，现有一个正常的慢请求接口a和非慢请求接口b，当我单独请求b时，响应速度正常。但是当我先请求a，当a还处于请求状态中的时候，我请求b，我发现b也变成了慢请求接口了。这个现象让我有一些猜测，有没有可能apache的并发模式在windows下工作的并不好？我去百度一下相关的信息。
 
 &emsp;&emsp;查了快2个小时，暂时放弃这个思路。
 
 &emsp;&emsp;先不去管apache的并发问题，重新来单独调试那个慢查询请求。
 
 - 在控制器第一行之后打断点。
   + 秒响应，没有问题。
 - 在第一行数据库查询语句后打断点。
   + 慢查询约40秒。
 - 接下来调试 get_nav_tree 方法，为防止断点影响之前的调用，写一个全局变量标识符。
   + 在 get_nav_tree 方法里面找到一个递归调用。
   + 我打印了每次调用的执行时间，发现根据不同的判断，每次递归可能会走进不同的逻辑分支，而有的分支中还会有数据库查询操作。最内层的调用大部分时间都很短，少部分执行时间较长。而外层的调用普遍时间都较长，越外层时间越久。

 ### 结论
 &emsp;&emsp;本质上，这是一个因为糟糕的代码逻辑导致的慢查询问题。递归查询数据库，也没有做递归层数限制，这还好也就是个后台代码，上线这么久了没人觉得有问题。
 
 ### 解决方案
&emsp;&emsp;最好的方式是重写这块逻辑，问问同事，答复是没有搞头。于是我把数据库切换为本地，立刻就不慢了。

 ### 总结
 
 &emsp;&emsp;这次调试花了非常久的时间，从早上9点到下午两点。效率比较低下，下面列一下原因：
 
 - 开发环境不熟悉。这家公司用虚拟桌面而且是windows虚拟桌面开发，网络限制贼多，我没法复用自己以前的开发环境，问题多多。
 - 调试过程中无法有效的定位问题。
   + 没有整块的审视代码逻辑。实际上如果事先仔细读一遍这块代码，不多也就100行。很明显就能发现这个递归调用。我的惯性思维让我就用打断点折半查找，但这种递归代码就是很难调试，我一开始还以为是这个方法在到达控制器之前就被别的地方反复调用。
   + 方法正确，但是对工具本身的不熟悉让我在调试到一个php之外的问题时无从下手。观察到问题现象以后，展现出的是一个复合问题。于是我尝试将其分割成两个问题，先集中思路解决其中一个。但是因为对apache和计算机网络相关知识的不熟悉，而且本身工作环境的网络资源受限严重，这个问题还是没能解决。 