---
title: 记一次线上redis主从故障排查
date: 2020-12-07 10:12:32
tags: [debug,redis]
---
&emsp;&emsp;还是之前哪个在生产环境运行的红包接龙小游戏发生了问题。

## 现象
&emsp;&emsp;老实讲这个服务一直还是挺稳定的，一个多月没有任何问题上报到我这，但是前几天又客服反馈，用户时长会出现获得礼物为0的情况，如下图所示：
![](/images/3.jpg)


&emsp;&emsp;这个其实现象跟上篇文章的现象是一致的，让我不禁想到难道是上回的问题没解决？

## 思路
&emsp;&emsp;我重新查询了一遍所有出现问题的游戏对局的这三个字段。
 1. 加入房间人数
 2. 房间最大人数
 3. 实际加入房间人数

![](/images/4.png)

&emsp;&emsp;可以很明显的看出，132020开始，所有出现问题的对局，三个指标都相等了。

&emsp;&emsp;这说明，本次问题虽然现象与之前一致，但是很可能是两个不同的原因导致的。

![](/images/5.png)

&emsp;&emsp;从图中也可以看出，整个10月份和11月份的大部分都是没有问题的，直到11月28日，问题陡然出现，然年后12月3日与12月4日接连一天出现了多次。

&emsp;&emsp;这里让我思考是否是28号做了什么更新，引发了这个问题？

## 猜测1：是否是28号更新了代码引发了这个问题

&emsp;&emsp;带着问题我去查git的提交记录。

&emsp;&emsp;最近两次的tag记录，分别在11月23日和12月2日。

&emsp;&emsp;很遗憾，这否定了我的猜想，二十八号并没有发生什么更新。

&emsp;&emsp;这时一个新的现象引起了我的注意，那就是12月3日和12月4日产生的异常数据中，每一局的数据返回的总奖品数量依然是约定好的总数1200。

&emsp;&emsp;这意味着什么？

&emsp;&emsp;这意味着随机算法在计算奖励的时候，就是按照七个人，而不是八个人来计算的。

&emsp;&emsp;也就是说，问题很可能出在获取当前加入游戏用户id列表的操作上。有可能获取的用户只有7个人。

## 猜测2：是否在读取参与游戏用户列表时，只读到了部分用户id？

&emsp;&emsp;重新阅读代码后我发现。游戏逻辑在最后一个用户加入后，将其id写入到redis。随后开始进入结算流程。

&emsp;&emsp;而在结算流程中，会从redis中取出刚写入的数据，进行游戏结算操作。

&emsp;&emsp;所以，如果redis返回的数据与之前写入的数据不一致，就会发生取到的参与用户不完整，最总导致我们看到的结果。

&emsp;&emsp;这个逻辑是能够自洽的。

&emsp;&emsp;读不到刚刚写入的数据，我们一般称之为脏读。如果是在数据库事务中，有可能是因为主从分离后数据需要同步，以及事务的隔离性，这都会导致脏读。

&emsp;&emsp;不过这是在redis中，我们暂且只考虑前一种可能。

&emsp;&emsp;于是我去问了相关的同事。果不其然，12月2日晚上，线上环境的redis拆成了1主3从的主从配置。这对于调用方本来是无感知的，因为主从分离操作在阿里云的redis网关处完成。但是数据同步延迟，让我这些对一致性较为敏感的服务出错了。

## 解决方案
&emsp;&emsp;所有一致性敏感的地方，我同意使用了自己保存的那一份数据，不在从redis中读取了。上线后还需要观察几天，看看能否真正解决这个问题。

## 总结

&emsp;&emsp;一个一直稳定的服务如果出了错，如果不是更新代码导致的。那么多半就是依赖的外部服务发生了变化。

&emsp;&emsp;这个方法当然不是百分百正确，不过第一时间从这个角度找问题，就算不能立刻解决，也能排除一个关键错误答案，事半功倍。
